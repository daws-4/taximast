# Migraci√≥n WhatsApp: FoxWhatsApp COM ‚Üí HTTP Backend

## Objetivo

Migrar el env√≠o de mensajes WhatsApp en TAXIMAST reemplazando la biblioteca COM `FoxWhatsApp.WhatsAppSel` por **peticiones HTTP (POST y GET)** hacia un backend externo que usar√° la API oficial de WhatsApp Business. Solo cambia la forma de env√≠o, los datos se mantienen id√©nticos.

---

## 1. An√°lisis Completo de Datos Actuales

### 1A. `servicios.SCT` ‚Äî Despacho de servicio (2 env√≠os)

#### Env√≠o al Chofer (unidad de taxi)

| Campo VFP | Tabla | Descripci√≥n |
|---|---|---|
| `TELECHOFE` | `SOCIOS.TELESOCI` | Tel√©fono del chofer (destino) |
| `SOLISERV` | `MSERV` | Solicitud/nombre del cliente |
| `DIRECLIE` | `MSERV` | Direcci√≥n del cliente |
| `REFECLIE` | `MSERV` | Referencia de ubicaci√≥n |
| `ENCOCLIE` | `MSERV` | Encomienda/contacto del cliente |
| `HORA1SER` | `MSERV` | Hora del servicio |
| üÜï `coordinates` | Backend | Coordenadas del cliente (si envi√≥ ubicaci√≥n por WhatsApp) |

**Mensaje construido:**
```
"CLIENTE: {SOLISERV} {DIRECLIE} {REFECLIE}, {ENCOCLIE} HORA:{HORA1SER}"
```

> [!TIP]
> **Nuevo: enlace de Google Maps.** Si el cliente envi√≥ su ubicaci√≥n por WhatsApp, el backend la almacena. VFP puede hacer un GET para obtener las coordenadas y agregar un enlace al mensaje del chofer:
> `https://maps.google.com/?q={lat},{lng}`

#### Env√≠o al Cliente

| Campo VFP | Tabla | Descripci√≥n |
|---|---|---|
| `CEDUCLIE` | `MSERV` | C√©dula/tel√©fono del cliente (destino) |
| `VERSEMPRE` | `EMPRESAS` | Mensaje/versi√≥n de la empresa |

---

### 1B. [mensaje.SCT](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/FORMS/mensaje.SCT) ‚Äî Env√≠o masivo a socios

| Campo VFP | Tabla | Descripci√≥n |
|---|---|---|
| `TELESOCI` | `SOCIOS` | Tel√©fono del socio (destino) |
| `thisform.text1.value` | Formulario | Texto escrito por operador |
| `HORA1SER` | `MSERV` | Hora (concatenado al mensaje) |

**Pre-carga:** `"LE SALUDA {NOMUSER} {APEUSER} SU OPERADOR(A) DE GUARDIA"`
**Condici√≥n:** `STATSOCIO # "0" .AND. WS1 = 1`

---

### 1C. `login.SCT` ‚Äî Inicializaci√≥n

| Dato | Valor |
|---|---|
| `Check1.value` | Checkbox "Conectar con WhatsApp" |
| `WS1` | Variable global: `1` = activo, `0` = inactivo |

---

## 2. Qu√© puedo hacer yo vs qu√© debes hacer t√∫

| Tarea | ¬øQui√©n? | Raz√≥n |
|---|---|---|
| Crear `whatsapp_http.prg` | ü§ñ **Yo** | Archivo [.PRG](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/PROGS/REPE.PRG) (texto plano) |
| Especificar backend | ü§ñ **Yo** (instrucciones) | T√∫ lo implementas en Next.js |
| Modificar `login.SCT` | üë§ **T√∫ en VFP** | Archivo binario |
| Modificar `servicios.SCT` | üë§ **T√∫ en VFP** | Archivo binario |
| Modificar [mensaje.SCT](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/FORMS/mensaje.SCT) | üë§ **T√∫ en VFP** | Archivo binario |

---

## 3. API Contract del Backend (Next.js)

> [!IMPORTANT]
> Esta es la especificaci√≥n que tu backend Next.js debe implementar. VFP enviar√° POST y GET a estos endpoints.

### Peticiones POST (VFP ‚Üí Backend)

#### `POST /api/whatsapp/send` ‚Äî Mensaje individual

**Request:**
```json
{
  "phone": "04121234567",
  "message": "CLIENTE: Juan Perez Av. Libertador Frente al banco HORA:10:30 AM https://maps.google.com/?q=10.4806,-66.9036",
  "type": "dispatch_driver"
}
```

| `type` | Cu√°ndo se usa |
|---|---|
| `dispatch_driver` | Mensaje al chofer al despachar servicio |
| `dispatch_client` | Mensaje al cliente al despachar servicio |
| `broadcast_partners` | Mensaje masivo a socios |

**Response (200):**
```json
{ "success": true, "messageId": "wamid.xxx" }
```

**Response (error):**
```json
{ "success": false, "error": "Descripci√≥n del error" }
```

#### `POST /api/whatsapp/send-bulk` ‚Äî Mensajes masivos

**Request:**
```json
{
  "messages": [
    { "phone": "04121234567", "message": "LE SALUDA Maria Garcia..." },
    { "phone": "04129876543", "message": "LE SALUDA Maria Garcia..." }
  ],
  "type": "broadcast_partners"
}
```

**Response (200):**
```json
{ "success": true, "sent": 15, "failed": 0 }
```

---

### Peticiones GET (VFP ‚Üí Backend)

#### `GET /api/whatsapp/status` ‚Äî Verificar conexi√≥n

**Response:**
```json
{ "connected": true, "service": "whatsapp-business-api" }
```

#### `GET /api/whatsapp/location?phone={phone}` ‚Äî Obtener √∫ltima ubicaci√≥n

> [!NOTE]
> Este endpoint es para el feature de coordenadas. El backend almacena ubicaciones recibidas v√≠a webhook de WhatsApp. VFP consulta la √∫ltima ubicaci√≥n del cliente antes de despachar.

**Request:** `GET /api/whatsapp/location?phone=04121234567`

**Response (con ubicaci√≥n):**
```json
{
  "found": true,
  "latitude": 10.4806,
  "longitude": -66.9036,
  "maps_url": "https://maps.google.com/?q=10.4806,-66.9036",
  "timestamp": "2026-02-15T10:30:00Z"
}
```

**Response (sin ubicaci√≥n):**
```json
{ "found": false }
```

---

### Webhook (WhatsApp ‚Üí Backend)

Tu backend Next.js necesitar√° un endpoint webhook para recibir mensajes entrantes de WhatsApp (incluyendo ubicaciones):

#### `POST /api/whatsapp/webhook` ‚Äî Recibe eventos de WhatsApp

Cuando un cliente env√≠a su ubicaci√≥n por WhatsApp, Meta env√≠a un webhook con:
```json
{
  "messages": [{
    "from": "584121234567",
    "type": "location",
    "location": {
      "latitude": 10.4806,
      "longitude": -66.9036
    }
  }]
}
```

El backend debe almacenar esas coordenadas asociadas al tel√©fono para que VFP las pueda consultar con el GET anterior.

---

## 4. Proposed Changes

### M√≥dulo HTTP (lo creo yo)

#### [NEW] [whatsapp_http.prg](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/PROGS/whatsapp_http.prg)

Funciones:

| Funci√≥n | Tipo HTTP | Descripci√≥n |
|---|---|---|
| `WA_CheckStatus()` | **GET** | Verifica conexi√≥n al backend |
| `WA_GetLocation(cPhone)` | **GET** | Obtiene coordenadas del cliente |
| `WA_SendMessage(cPhone, cMsg, cType)` | **POST** | Env√≠a mensaje individual |
| `WA_SendBulk(cJsonArray, cType)` | **POST** | Env√≠a mensajes masivos |
| `WA_HttpPost(cUrl, cJson)` | **POST** | Wrapper HTTP gen√©rico |
| `WA_HttpGet(cUrl)` | **GET** | Wrapper HTTP gen√©rico |
| `WA_EscapeJson(cText)` | ‚Äî | Escapa caracteres para JSON |

---

### Formulario de Login (lo haces t√∫ en VFP)

#### [MODIFY] [login.SCT](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/FORMS/login.SCT)

En el evento **Click** del bot√≥n de login, reemplaza el bloque `Check1`:

```diff
 if ThisForm.Check1.value = 1
    WS1 = 1
-   PUBLIC loWsp
-   loWsp = CREATEOBJECT('FoxWhatsApp.WhatsAppSel')
-   loWsp.lcCorreoLicencia = "servitelv@gmail.com"
-   loWsp.lcPerfil = "Default"
-   loWsp.lnModoInteraccion = 1
-   WAIT WINDOW "Conectando con WhatsApp..." NOWAIT
-   loWsp.conecta()
-   loWsp.Viewwhatsappweb(.t.)
+   SET PROCEDURE TO PROGS\whatsapp_http ADDITIVE
+   WAIT WINDOW "Verificando conexi√≥n WhatsApp..." NOWAIT
+   IF WA_CheckStatus()
+      WAIT WINDOW "WhatsApp conectado" TIMEOUT 2
+   ELSE
+      MESSAGEBOX("No se pudo conectar con WhatsApp", 16, "Error")
+      WS1 = 0
+      ThisForm.Check1.value = 0
+   ENDIF
 ELSE
    WS1 = 0
 endif
```

---

### Formulario de Servicios (lo haces t√∫ en VFP)

#### [MODIFY] [servicios.SCT](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/FORMS/servicios.SCT)

En el evento **Click** del despacho, reemplazar `lowsp.SendMessage(...)`:

```diff
 && Env√≠o al chofer:
-lowsp.SendMessage(RTRIM(TELECHOFE),+"CLIENTE: "...)
+lcMsg = "CLIENTE: "+RTRIM(mserv.soliserv)+" "+RTRIM(mserv.direclie) ;
+   +" "+RTRIM(mserv.refeclie)+", "+RTRIM(MSERV.ENCOCLIE) ;
+   +" HORA:"+RTRIM(MSERV.HORA1SER)
+
+&& Intentar agregar enlace de ubicaci√≥n
+lcLocation = WA_GetLocation(RTRIM(MSERV.CEDUCLIE))
+IF !EMPTY(lcLocation)
+   lcMsg = lcMsg + " " + lcLocation
+ENDIF
+
+WA_SendMessage(RTRIM(TELECHOFE), lcMsg, "dispatch_driver")

 && Env√≠o al cliente:
-lowsp.SendMessage(RTRIM(MSERV.CEDUCLIE),RTRIM(empresas.versempre))
+WA_SendMessage(RTRIM(MSERV.CEDUCLIE), RTRIM(empresas.versempre), "dispatch_client")
```

---

### Formulario de Mensajes (lo haces t√∫ en VFP)

#### [MODIFY] [mensaje.SCT](file:///c:/Users/USUARIO/Desktop/proyectos/taximast/taximast/FORMS/mensaje.SCT)

En el `DO WHILE` del env√≠o masivo:

```diff
-lo.SendMessage(RTRIM(TELESOCI),+RTRIM(thisform.text1.value)+", "+RTRIM(MSERV.HORA1SER))
+lcMsg = RTRIM(thisform.text1.value)+", "+AMPM(TIME())
+WA_SendMessage(RTRIM(TELESOCI), lcMsg, "broadcast_partners")
```

---

## 5. Verificaci√≥n

1. **Compilar** `whatsapp_http.prg` en VFP y probar funciones aisladas desde la ventana de comandos
2. **Levantar** tu backend Next.js (aunque sea solo loggeando peticiones)
3. **Probar login** ‚Üí VFP hace GET a `/api/whatsapp/status`
4. **Probar despacho** ‚Üí VFP hace GET a `/api/whatsapp/location` + POST a `/api/whatsapp/send`
5. **Probar masivo** ‚Üí VFP hace POST a `/api/whatsapp/send-bulk`
6. **Verificar** en logs del backend que los datos llegan correctos
